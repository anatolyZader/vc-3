name: Full deploy

on:
  push:
    branches: [amber] 


jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
      GCP_PROJECT: eventstorm-1
      REGION: me-west1
      GCP_BUCKET: eventstorm-bucket
      REDIS_HOST: 10.187.8.27

    steps:
    - uses: actions/checkout@v4

    # 1. Authenticate first!
    - name: Authenticate with GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    # 2. Now setttt up the Cloud SDK
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT }}

    # 3. Now debug/check auth
    - name: Debug GCP Auth
      run: |
        gcloud auth list
        gcloud config list
        gsutil ls gs://$GCP_BUCKET/

    # 4. Set up Node.js for both client and backend
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'

    # --- FRONTEND: Build and Upload to GCP Storage ---
    - name: Build React client
      run: |
        cd client
        npm install
        npm run build

    - name: Clear existing files in bucket
      run: |
        gsutil -m rm -r gs://$GCP_BUCKET/** || true

    - name: Upload static files to a bucket
      run: |
        gsutil -m rsync -r ./client/dist gs://$GCP_BUCKET/

    # --- BACKEND: Deploy to Cloud Run from source ---
    - name: Deploy Fastify backend to Cloud Run from source
      run: |
        cd backend
        gcloud run deploy fastify-backend \
        --source . \
        --region $REGION \
        --project $GCP_PROJECT \
        --platform managed \
        --allow-unauthenticated \
        --set-env-vars=NODE_ENV=production,REDIS_PORT=6379,PG_USER=postgres,JWT_EXPIRE_IN=1h,REDIS_HOST=$REDIS_HOST,CLOUD_SQL_CONNECTION_NAME=eventstorm-1:me-west1:eventstorm-pg-instance,DUMMY=MUDDYY \
        --set-secrets=JWT_SECRET=jwt-secret:latest,GCP_OAUTH2_CLIENT_SECRET=google-oauth2-secret:latest,PG_PASSWORD=pg-pwd:latest,COOKIE_SECRET=cookie-secret:latest,SESSION_SECRET=session-secret:latest,GITHUB_TOKEN=github-token:latest
















